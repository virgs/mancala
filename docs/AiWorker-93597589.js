var m=Object.defineProperty;var f=(d,h,l)=>h in d?m(d,h,{enumerable:!0,configurable:!0,writable:!0,value:l}):d[h]=l;var c=(d,h,l)=>(f(d,typeof h!="symbol"?h+"":h,l),l);(function(){"use strict";class d{constructor(e){c(this,"board");c(this,"movesRecord");this.board=[...e],this.movesRecord=[]}getLastIncrementedPitId(){return this.movesRecord[this.movesRecord.length-1].pitId}getPitSeeds(e){return this.board[e]}setPitSeeds(e,t){const s=this.board[e];return this.board[e]=t,this.movesRecord.push({pitId:e,seeds:this.board[e]}),s}getBoard(){return this.board}transferSeeds(e,t){const s=this.board[e];this.setPitSeeds(e,0),this.incrementPitSeeds(t,s)}incrementPitSeeds(e,t=1){return this.setPitSeeds(e,t+this.board[e])}getMovesRecord(){return this.movesRecord}}var h=(n=>(n.TOP="TOP",n.BOTTOM="BOTTOM",n))(h||{});const l=n=>n==="TOP"?"BOTTOM":"TOP";class v{constructor(e){c(this,"boardLength");c(this,"totalStones");this.boardLength=e.length,this.totalStones=e.reduce((t,s)=>t+s,0)}getSideStorePitId(e){return e===h.TOP?this.boardLength/2-1:this.boardLength-1}getOppositeSideStorePitId(e){return e!==h.TOP?this.boardLength/2-1:this.boardLength-1}getOppositeSidePitId(e){return this.boardLength-2-e}isPocketStore(e){return e===this.boardLength/2-1||e===this.boardLength-1}checkPocketOwnership(e,t){return e===h.TOP&&t<this.boardLength/2||e===h.BOTTOM&&t>=this.boardLength/2}getNextPocketId(e){return(e+1)%this.boardLength}}class M{constructor(e){c(this,"playerSide");this.playerSide=e}checkPlayerScore(e){return e[new v(e).getSideStorePitId(this.playerSide)]}checkOppositePlayerScore(e){return e[new v(e).getOppositeSideStorePitId(this.playerSide)]}getAvailableMovesForPlayer(e){const t=new v(e);return e.reduce((s,r,o)=>(t.checkPocketOwnership(this.playerSide,o)&&!t.isPocketStore(o)&&r>0&&s.push(o),s),[])}getAvailableMovesForOpponentPlayer(e){const t=new v(e);return e.reduce((s,r,o)=>(t.checkPocketOwnership(l(this.playerSide),o)&&!t.isPocketStore(o)&&r>0&&s.push(o),s),[])}}class O{constructor(e,t){c(this,"staticBoardAnalyser");c(this,"engineSettings");c(this,"movesHistory");this.staticBoardAnalyser=new v(e),this.movesHistory=[],this.engineSettings=t||{}}makeMove(e,t){this.validateMove(e,t);const s=e.playerSide;this.movesHistory.push(e);const r=this.redistributeSeeds(e,t),o=r.getLastIncrementedPitId(),a=this.checkCapture(s,o,r.getBoard()),i=this.checkGameOver(s,a.getBoard());return i?{winningPlayer:i.winningPlayer,nextTurnPlayer:s,boardConfig:i.boardConfig,gameOver:!0,movesRecord:this.engineSettings.recordMoves?r.getMovesRecord().concat(a.getMovesRecord()).concat(i.gameOverMovesRecord):void 0}:{nextTurnPlayer:this.checkNextPlayerTurn(s,o),boardConfig:a.getBoard(),gameOver:!1,movesRecord:this.engineSettings.recordMoves?r.getMovesRecord().concat(a.getMovesRecord()):void 0}}redistributeSeeds(e,t){const s=new d(t);let r=e.pitId,o=s.setPitSeeds(r,0);for(;o>0;)r=this.staticBoardAnalyser.getNextPocketId(r),!(this.staticBoardAnalyser.isPocketStore(r)&&!this.staticBoardAnalyser.checkPocketOwnership(e.playerSide,r))&&(s.incrementPitSeeds(r),--o);return s}getMovesHistory(){return this.movesHistory}checkNextPlayerTurn(e,t){return this.staticBoardAnalyser.checkPocketOwnership(e,t)&&this.staticBoardAnalyser.isPocketStore(t)?e:l(e)}checkCapture(e,t,s){const r=new d(s);if(this.staticBoardAnalyser.checkPocketOwnership(e,t)&&r.getPitSeeds(t)===1&&!this.staticBoardAnalyser.isPocketStore(t)){const o=this.staticBoardAnalyser.getOppositeSidePitId(t);if(r.getPitSeeds(o)>0){const a=this.staticBoardAnalyser.getSideStorePitId(e);r.transferSeeds(o,a),r.transferSeeds(t,a)}}return r}validateMove(e,t){if(!this.staticBoardAnalyser.checkPocketOwnership(e.playerSide,e.pitId))throw new Error(`Player '${e.playerSide}' cannot select an opponent's pit (${e.pitId})`);if(this.staticBoardAnalyser.isPocketStore(e.pitId))throw new Error(`Player '${e.playerSide}' cannot select a store (${e.pitId})`);if(t[e.pitId]===0)throw new Error(`Player '${e.playerSide}' cannot select an empty pit (${e.pitId})`)}checkGameOver(e,t){const s=new M(e);if(s.getAvailableMovesForPlayer(t).length!==0&&s.getAvailableMovesForOpponentPlayer(t).length!==0)return;const r=s.checkPlayerScore(t),o=s.checkOppositePlayerScore(t),a=this.getGameOverMovesRecord(t,e);let i;return r>o?i=e:r<o&&(i=l(e)),{gameOver:!0,boardConfig:a.getBoard(),gameOverMovesRecord:a.getMovesRecord(),winningPlayer:i}}getGameOverMovesRecord(e,t){const s=new d(e);if(this.engineSettings.gameOverCaptureVariation){const r=this.staticBoardAnalyser.getSideStorePitId(t);e.forEach(i=>{this.staticBoardAnalyser.checkPocketOwnership(t,i)&&i!==r&&s.transferSeeds(i,r)});const o=l(t),a=this.staticBoardAnalyser.getSideStorePitId(o);e.forEach(i=>{this.staticBoardAnalyser.checkPocketOwnership(o,i)&&i!==a&&s.transferSeeds(i,a)})}return s}}var y=(n=>(n[n.BEGINNER=0]="BEGINNER",n[n.MEDIUM=1]="MEDIUM",n[n.HARD=2]="HARD",n[n.HARDCORE=3]="HARDCORE",n))(y||{});class k{constructor(e,t,s){c(this,"maxDepth");c(this,"aiBainLevel");c(this,"playerSide");c(this,"engine");c(this,"playerMovesAnalyser");c(this,"movesAnalysed");c(this,"aborted");switch(this.aiBainLevel=e,this.aborted=!1,this.movesAnalysed=0,this.playerMovesAnalyser=new M(t),this.engine=new O(s),this.playerSide=t,this.maxDepth=0,e){case y.BEGINNER:this.maxDepth=0;break;case y.MEDIUM:this.maxDepth=1;break;case y.HARD:this.maxDepth=3;break;case y.HARDCORE:this.maxDepth=10;break}}abort(){this.aborted=!0}async selectBestMove(e){this.movesAnalysed=0,console.log("thinking");const t=this.playerMovesAnalyser.getAvailableMovesForPlayer(e);let s=t[t.length-1];return t.length>1&&this.maxDepth>0&&t.reduce((r,o)=>{const a=this.engine.makeMove({playerSide:this.playerSide,pitId:o},e),i=this.evaluate(a.boardConfig,0,-1/0,1/0,a.nextTurnPlayer);return i>r&&(r=i,s=o),r},-1/0),console.log("done thinking",y[this.aiBainLevel],this.movesAnalysed),s}evaluate(e,t,s,r,o){++this.movesAnalysed;const a=this.playerMovesAnalyser.getAvailableMovesForPlayer(e).length===0||this.playerMovesAnalyser.getAvailableMovesForOpponentPlayer(e).length===0;if(t>=this.maxDepth||a||o===void 0)return this.playerMovesAnalyser.checkPlayerScore(e)-this.playerMovesAnalyser.checkOppositePlayerScore(e);if(o===this.playerSide){let i=-1/0;const p=this.playerMovesAnalyser.getAvailableMovesForPlayer(e);for(let P of p){const g=this.engine.makeMove({playerSide:o,pitId:P},e),u=this.evaluate(g.boardConfig,t+1,s,r,g.nextTurnPlayer);if(i=Math.max(i,u),s=Math.max(s,u),r<=s)break}return i}else{let i=1/0;const p=this.playerMovesAnalyser.getAvailableMovesForOpponentPlayer(e);for(let P of p){const g=this.engine.makeMove({playerSide:o,pitId:P},e),u=this.evaluate(g.boardConfig,t+1,s,r,g.nextTurnPlayer);if(i=Math.min(i,u),r=Math.min(r,u),r<=s)break}return i}}}let S;self.onmessage=async n=>{if(n.data.abort)S.abort();else{const e=n.data,t=JSON.parse(e.boardConfig);S=new k(e.brainLevel,e.playingPlayer,t);const s=await S.selectBestMove(t);self.postMessage({bestPocketIdToPlay:s})}}})();
